import random
import pygame
import sys

# --- Initialisation Pygame ---
pygame.init()

# Paramètres de l'écran
largeur_fenetre = 1000
hauteur_fenetre = 600
# Le plateau de jeu utilisera 600x600 (les premiers pixels)
largeur_jeu = 600
hauteur_jeu = 600 

screen = pygame.display.set_mode((largeur_fenetre, hauteur_fenetre))
pygame.display.set_caption("Morpion - Accueil & Jeu")

# --- Définition des Couleurs ---
BLANC = (255, 255, 255)
GRIS_CLAIR = (220, 220, 220)
VIOLET = (148, 0, 211)
NOIR = (0, 0, 0)
JAUNE = (255, 255, 0)
VERT = (0, 150, 0)
ROUGE = (200, 0, 0)

# --- Chargement et Redimensionnement de l'Image de Fond ---
try:
    background = pygame.image.load("fond_morpion.jpg")
    background = pygame.transform.scale(background, (largeur_jeu, hauteur_jeu)) 
except pygame.error:
    print("Erreur: Image 'fond_morpion.jpg' non trouvée. Utilisant un fond noir de secours.")
    background = None
    
# --- Définition des Polices ---
font_accueil = pygame.font.SysFont('Gorgia', 30)
font_titre_regles = pygame.font.SysFont('Gorgia', 45, bold=True)
font_regles = pygame.font.SysFont('Gorgia', 25)
font_jeu = pygame.font.SysFont('Gorgia', 80)
font_message = pygame.font.SysFont('Gorgia', 40)
font_bot = pygame.font.SysFont('Gorgia', 30, italic=True)

# --- Gestion des États ---
ACCUEIL = 0
REGLES = 1
JEU = 2
etat_actuel = ACCUEIL

# --- Paramètres du Bot (pour le délai) ---
TEMPS_ATTENTE_BOT = 1000 # 1000 millisecondes = 1 seconde
temps_debut_tour_bot = 0

# --- Préparation du Texte d'Accueil (Débordement) ---
message = "Bienvenus, voici un jeu de morpion contre un bot !"
max_width_accueil = 380
lines_accueil = []
words_accueil = message.split()
current_line = ""
for word in words_accueil:
    test_line = current_line + word + " "
    text_surface_test = font_accueil.render(test_line, True, VIOLET)
    if text_surface_test.get_width() <= max_width_accueil:
        current_line = test_line
    else:
        lines_accueil.append(current_line)
        current_line = word + " "
lines_accueil.append(current_line)

# --- Les Règles ---
texte_instructions = [
    "--- Les Règles du Morpion ---",
    "",
    "1. Le jeu se déroule sur une grille de 3x3.",
    "2. Le **Joueur X** commence, l'ordinateur (Bot) est le **Joueur O**.",
    "3. Les joueurs placent à tour de rôle leur symbole dans une case vide.",
    "4. Le premier joueur à aligner trois de ses symboles",
    "   (horizontalement, verticalement ou en diagonale) gagne la partie.",
    "5. Si toutes les cases sont remplies et qu'aucun joueur n'a gagné,",
    "   la partie est déclarée **Match Nul**.",
    "",
    "Bonne chance." 
]

# --- Paramètres du Jeu  ---
plateau = [" "] * 9
joueur_actuel = "X"
jeu_en_cours = True
message_final = ""
couleur_message = NOIR
taille_case = largeur_jeu // 3 
lignes_grille = [
    (taille_case, 0, taille_case, hauteur_jeu),
    (2 * taille_case, 0, 2 * taille_case, hauteur_jeu),
    (0, taille_case, largeur_jeu, taille_case),
    (0, 2 * taille_case, largeur_jeu, 2 * taille_case)
]

# --- Fonctions du Jeu ---

def reinitialiser_jeu():
    """Réinitialise les variables pour commencer une nouvelle partie."""
    global plateau, joueur_actuel, jeu_en_cours, message_final, temps_debut_tour_bot
    plateau = [" "] * 9
    joueur_actuel = "X"
    jeu_en_cours = True
    message_final = ""
    temps_debut_tour_bot = 0

def verifier_victoire(plateau):
    """Vérifie si un joueur a gagné."""
    victoires = [
        (0, 1, 2), (3, 4, 5), (6, 7, 8), (0, 3, 6), (1, 4, 7), (2, 5, 8), (0, 4, 8), (2, 4, 6)
    ]
    for a, b, c in victoires:
        if plateau[a] == plateau[b] == plateau[c] != " ":
            return plateau[a]
    if " " not in plateau:
        return "NUL"
    return None

def coup_bot(plateau):
    """Le bot choisit une position aléatoire parmi les positions disponibles."""
    positions_disponibles = [i for i, val in enumerate(plateau) if val == " "]
    if positions_disponibles:
        return random.choice(positions_disponibles)
    return -1

def gerer_clic(pos, joueur_actuel, plateau):
    """Détermine quelle case a été cliquée et met à jour le plateau."""
    x, y = pos
    if x >= largeur_jeu:
        return False, -1
    col = x // taille_case
    ligne = y // taille_case
    position = ligne * 3 + col
    if 0 <= position < 9 and plateau[position] == " ":
        plateau[position] = joueur_actuel
        return True, position
    return False, -1

# --- Fonctions d'Affichage des Écrans ---

def dessiner_accueil():
    """Affiche l'écran d'accueil."""
    screen.fill(BLANC)
    if background:
        screen.blit(background, (0, 0))
    else:
        pygame.draw.rect(screen, NOIR, (0, 0, 600, 600)) 

    pygame.draw.rect(screen, GRIS_CLAIR, (largeur_jeu, 0, largeur_fenetre - largeur_jeu, hauteur_fenetre))
    y_offset = 200
    for line in lines_accueil:
        text_surface = font_accueil.render(line, True, VIOLET)
        screen.blit(text_surface, (largeur_jeu + 20, y_offset))
        y_offset += 30
      
    instruction_regle = font_regles.render("Appuyez sur R pour lire les règles", True, NOIR)
    screen.blit(instruction_regle, (largeur_jeu + 20, 500))

    # Retiré : instruction_start = font_regles.render("Appuyez sur ESPACE pour commencer le jeu", True, VIOLET)
    
def dessiner_regles():
    """Affiche l'écran des règles."""
    screen.fill(JAUNE)
    pygame.draw.rect(screen, NOIR, (50, 50, 900, 500), 5) 

    titre_surface = font_titre_regles.render(texte_instructions[0], True, NOIR)
    screen.blit(titre_surface, (100, 80))
    
    y_offset = 150
    for line in texte_instructions[1:]:
        # Afficher la dernière ligne (démarrer le jeu) en violet
        couleur_texte = VIOLET if "COMMENCER" in line else NOIR
        text_surface = font_regles.render(line, True, couleur_texte)
        screen.blit(text_surface, (100, y_offset))
        y_offset += 35
        
    instruction_retour = font_regles.render("Appuyez sur ESPACE pour COMMENCER le jeu", True, VIOLET)
    screen.blit(instruction_retour, (100, 520))

def dessiner_jeu(current_time):
    """Dessine le plateau de jeu et les informations de statut."""
    # Affichage du Plateau
    plateau_zone = pygame.Rect(0, 0, largeur_jeu, hauteur_jeu)
    screen.fill(GRIS_CLAIR, plateau_zone)
    for x1, y1, x2, y2 in lignes_grille:
        pygame.draw.line(screen, NOIR, (x1, y1), (x2, y2), 5)

    for i in range(9):
        symbole = plateau[i]
        if symbole != " ":
            col = i % 3
            ligne = i // 3
            centre_x = col * taille_case + taille_case // 2
            centre_y = ligne * taille_case + taille_case // 2
            couleur = ROUGE if symbole == "X" else VERT
            texte_surface = font_jeu.render(symbole, True, couleur)
            texte_rect = texte_surface.get_rect(center=(centre_x, centre_y))
            screen.blit(texte_surface, texte_rect)
            
    # Affichage du Statut
    statut_zone = pygame.Rect(largeur_jeu, 0, largeur_fenetre - largeur_jeu, hauteur_fenetre)
    screen.fill(BLANC, statut_zone)
    
    # Message principal de tour/fin de partie
    if jeu_en_cours:
        tour_msg = f"Tour du joueur: {joueur_actuel}"
        couleur_tour = ROUGE if joueur_actuel == "X" else VERT
    else:
        tour_msg = "Partie terminée !"
        couleur_tour = NOIR

    tour_surface = font_message.render(tour_msg, True, couleur_tour)
    screen.blit(tour_surface, (largeur_jeu + 20, 50))
    
    # Message d'attente du bot 
    if jeu_en_cours and joueur_actuel == "O":
        # Clignotement du texte
        if (current_time // 500) % 2 == 0: 
            bot_msg = "Le bot réfléchit..."
            bot_surface = font_bot.render(bot_msg, True, VERT)
            screen.blit(bot_surface, (largeur_jeu + 20, 110))

    # Message final de victoire/nul
    if message_final:
        # Message final dans la zone de jeu
        message_surface = font_message.render(message_final, True, couleur_message, BLANC)
        message_rect = message_surface.get_rect(center=(largeur_jeu // 2, hauteur_jeu // 2))
        screen.blit(message_surface, message_rect)

        # Bouton Rejouer dans la zone de statut
        bouton_rect = pygame.Rect(largeur_jeu + 50, hauteur_fenetre - 100, 300, 70)
        pygame.draw.rect(screen, VIOLET, bouton_rect)
        texte_bouton = font_regles.render("Rejouer (R)", True, BLANC)
        texte_bouton_rect = texte_bouton.get_rect(center=bouton_rect.center)
        screen.blit(texte_bouton, texte_bouton_rect)

# --- BOUCLE PRINCIPALE du Jeu ---
running = True
while running:
    
    current_time = pygame.time.get_ticks()
    
    
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False
            
        if event.type == pygame.KEYDOWN:
            # --- Transition Accueil (0) ---
            if etat_actuel == ACCUEIL:
                if event.key == pygame.K_r:
                    etat_actuel = REGLES # ACCUEIL -> REGLES (obligatoire)

            # --- Transition Règles (1) ---
            elif etat_actuel == REGLES:
                if event.key == pygame.K_SPACE:
                    reinitialiser_jeu()
                    etat_actuel = JEU # REGLES -> JEU (obligatoire)

            # --- Transition Jeu (2) ---
            elif etat_actuel == JEU:
                if event.key == pygame.K_r and not jeu_en_cours:
                    reinitialiser_jeu() # Rejouer en fin de partie
                
                if event.key == pygame.K_ESCAPE:
                    etat_actuel = ACCUEIL # JEU -> ACCUEIL

        if event.type == pygame.MOUSEBUTTONDOWN and etat_actuel == JEU:
            pos = pygame.mouse.get_pos()
            
            # Clic dans la zone de jeu (uniquement joueur X)
            if pos[0] < largeur_jeu and jeu_en_cours and joueur_actuel == "X":
                clic_reussi, _ = gerer_clic(pos, joueur_actuel, plateau)
                if clic_reussi:
                    gagnant = verifier_victoire(plateau)
                    if gagnant:
                        jeu_en_cours = False
                    else:
                        joueur_actuel = "O"
                        temps_debut_tour_bot = current_time
            
            # Clic sur le bouton Rejouer (dans la zone de statut)
            elif not jeu_en_cours:
                bouton_rect = pygame.Rect(largeur_jeu + 50, hauteur_fenetre - 100, 300, 70)
                if bouton_rect.collidepoint(pos):
                    reinitialiser_jeu()

    
    
    if etat_actuel == ACCUEIL:
        
        dessiner_accueil()
        
    elif etat_actuel == REGLES:
        
        dessiner_regles()
        
    elif etat_actuel == JEU:
        
        # Logique du Bot (avec délai)
        if joueur_actuel == "O" and jeu_en_cours:
            
            if current_time - temps_debut_tour_bot >= TEMPS_ATTENTE_BOT:
            
                position_bot = coup_bot(plateau)
                
                if position_bot != -1:
                    plateau[position_bot] = "O"
                    gagnant = verifier_victoire(plateau)
                    if gagnant:
                        jeu_en_cours = False
                    else:
                        joueur_actuel = "X"
                else:
                     jeu_en_cours = False
        
        # Vérification de Fin de Partie (gestion du message final)
        if not jeu_en_cours and not message_final:
            gagnant = verifier_victoire(plateau)
            if gagnant == "X":
                message_final = "Félicitations, tu as gagné !"
                couleur_message = ROUGE
            elif gagnant == "O":
                message_final = "Le bot a gagné !"
                couleur_message = VERT
            elif gagnant == "NUL":
                message_final = "Match nul !"
                couleur_message = VIOLET

        # Affichage du Jeu
        dessiner_jeu(current_time)
        
   
    pygame.display.flip()

pygame.quit()
sys.exit()
